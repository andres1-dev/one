<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Ingresos | Consolidado</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS (versión slim) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <!-- Font Awesome (solo los iconos necesarios) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --light-gray: #f8f9fa;
            --dark-gray: #212529;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-gray);
            line-height: 1.6;
        }
        
        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }
        
        .card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1.25rem 1.5rem;
        }
        
        .card-title {
            font-weight: 600;
            color: var(--dark-gray);
            margin: 0;
        }
        
        .filter-container {
            background-color: white;
            padding: 1.25rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            box-shadow: var(--box-shadow);
        }
        
        .filter-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        
        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        
        .summary-item {
            text-align: center;
            padding: 0 1rem;
        }
        
        .summary-item:not(:last-child) {
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .summary-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .table {
            --bs-table-color: var(--dark-gray);
            --bs-table-striped-bg: rgba(67, 97, 238, 0.03);
        }
        
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            padding: 0.75rem 1.25rem;
            font-size: 0.85rem;
        }
        
        .dataTables_wrapper .dataTables_filter input {
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
            padding: 0.375rem 0.75rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .filter-container .col-md-3,
            .filter-container .col-md-4 {
                margin-bottom: 1rem;
            }
            
            .summary-item {
                border-right: none;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                padding: 1rem 0;
            }
            
            .summary-item:last-child {
                border-bottom: none;
            }
            
            .dataTables_wrapper .dataTables_length,
            .dataTables_wrapper .dataTables_filter {
                margin-bottom: 1rem;
            }
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <div class="card fade-in">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                <h5 class="card-title">Consolidado de Ingresos</h5>
                <div class="mt-2 mt-md-0">
                    <button id="refresh-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt me-1"></i> Actualizar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filtros -->
                <div class="filter-container fade-in">
                    <div class="row g-3">
                        <div class="col-md-4 col-lg-3">
                            <label class="filter-label">Rango de fechas</label>
                            <input type="text" id="filterFecha" class="form-control form-control-sm flatpickr-input" placeholder="Seleccionar fechas">
                        </div>
                        <div class="col-md-4 col-lg-3">
                            <label class="filter-label">Proveedor</label>
                            <select id="filterProveedor" class="form-select form-select-sm">
                                <option value="">Todos los proveedores</option>
                            </select>
                        </div>
                        <div class="col-md-4 col-lg-3">
                            <label class="filter-label">Línea</label>
                            <select id="filterLinea" class="form-select form-select-sm">
                                <option value="">Todas las líneas</option>
                            </select>
                        </div>
                        <div class="col-md-4 col-lg-3">
                            <label class="filter-label">Gestor</label>
                            <select id="filterGestor" class="form-select form-select-sm">
                                <option value="">Todos los gestores</option>
                            </select>
                        </div>
                        <div class="col-md-4 col-lg-3">
                            <label class="filter-label">Clase</label>
                            <select id="filterClase" class="form-select form-select-sm">
                                <option value="">Todas las clases</option>
                            </select>
                        </div>
                        <div class="col-md-4 col-lg-3">
                            <label class="filter-label">Fuente</label>
                            <select id="filterFuente" class="form-select form-select-sm">
                                <option value="">Todas las fuentes</option>
                                <option value="SISPRO">SISPRO</option>
                                <option value="BUSINT">BUSINT</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen -->
                <div class="summary-card fade-in">
                    <div class="row g-0 text-center">
                        <div class="col-md-4 summary-item">
                            <div class="summary-title">Registros</div>
                            <div class="summary-value" id="total-records">0</div>
                        </div>
                        <div class="col-md-4 summary-item">
                            <div class="summary-title">Cantidad Total</div>
                            <div class="summary-value" id="total-quantity">0</div>
                        </div>
                        <div class="col-md-4 summary-item">
                            <div class="summary-title">Valor Total</div>
                            <div class="summary-value" id="total-pvp">$0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla -->
                <div class="table-responsive fade-in">
                    <table id="data-table" class="table table-hover table-striped" style="width:100%"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts optimizados -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    
    <!-- Módulos -->
    <script type="module">
        import { getCombinedData } from './sheets-api.js';
        import { initializeDataTable, updateDataTable } from './datatable-manager2.js';
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const data = await getCombinedData();
                initializeDataTable(data);
            } catch (error) {
                console.error("Error al cargar datos:", error);
                showAlert("Error al cargar datos. Por favor recarga la página.", "danger");
            }
            
            document.getElementById('refresh-btn').addEventListener('click', async () => {
                try {
                    const btn = document.getElementById('refresh-btn');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Actualizando...';
                    btn.disabled = true;
                    
                    const data = await getCombinedData();
                    updateDataTable(data);
                    
                    btn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Actualizar';
                    btn.disabled = false;
                    showAlert("Datos actualizados correctamente", "success");
                } catch (error) {
                    console.error("Error al actualizar datos:", error);
                    showAlert("Error al actualizar datos. Intenta nuevamente.", "danger");
                }
            });
        });
        
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.maxWidth = '350px';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 3000);
        }
    </script>
</body>
</html>
