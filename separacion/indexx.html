<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Sistema de Gestión de Documentos - Separación">
    <title>Sistema de Gestión de Documentos</title>
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">    
    
    <!-- Estilos Personalizados -->
    <link rel="stylesheet" href="css/styles2.css">


    <!-- CSS para asegurar que el loader esté oculto -->
<style>
  #loader {
    display: none !important;
  }
</style>

    <style>
    /* Ocultar elementos específicos */
    #recInput,
    button[onclick="buscarPorREC()"],
    button[onclick="imprimirSoloClientes()"],
    button[onclick="mostrarOpcionesImpresion()"] {
        display: none !important;
    }
    
    /* Ajustar el layout de los filtros */
    .filtros-grid {
        grid-template-columns: 1fr auto !important;
    }
    
    .filtro-group:last-child .btn-group-sm {
        gap: 0.25rem;
    }

    /* ===== HEADER MEJORADO ===== */
    .header-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: nowrap;
    }

    .control-item {
        display: flex;
        align-items: center;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        transition: all var(--transition-base);
        overflow: hidden;
    }

    .control-item:hover {
        border-color: var(--accent-color);
        box-shadow: var(--shadow-sm);
    }

    .flatpickr-control {
        min-width: 150px;
        max-width: 180px;
    }

    .flatpickr-header-input {
        width: 100%;
        font-size: 0.8125rem !important;
        padding: 0.5rem 0.75rem !important;
        border: none !important;
        background: transparent !important;
        color: var(--text-primary) !important;
        cursor: pointer;
        text-align: center;
    }

    .flatpickr-header-input:focus {
        outline: none;
        box-shadow: none !important;
    }

    .flatpickr-header-input::placeholder {
        color: var(--text-muted);
        font-size: 0.8125rem;
    }

    .control-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.875rem;
        background: transparent;
        border: none;
        color: var(--text-primary);
        font-size: 0.8125rem;
        font-weight: 500;
        transition: all var(--transition-fast);
        white-space: nowrap;
        height: 100%;
    }

    .control-btn:hover {
        background: rgba(15, 52, 96, 0.05);
        color: var(--accent-color);
    }

    .control-btn i {
        font-size: 0.875rem;
        color: var(--accent-color);
        transition: color var(--transition-fast);
    }

    .control-btn:hover i {
        color: var(--accent-light);
    }

    /* Botón de menú móvil */
    .mobile-menu-btn {
        display: none;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        background: var(--bg-secondary);
        color: var(--accent-color);
        font-size: 1.125rem;
        transition: all var(--transition-fast);
    }

    .mobile-menu-btn:hover {
        border-color: var(--accent-color);
        background: rgba(15, 52, 96, 0.05);
        transform: rotate(90deg);
    }

    /* Modal de controles móviles */
    .controls-modal .modal-header {
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-light);
    }

    .controls-modal .modal-body {
        padding: 1.5rem;
    }

    .control-option {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        margin-bottom: 0.75rem;
        transition: all var(--transition-fast);
        cursor: pointer;
        background: var(--bg-secondary);
    }

    .control-option:hover {
        border-color: var(--accent-color);
        background: rgba(15, 52, 96, 0.03);
        transform: translateX(4px);
    }

    .control-option:last-child {
        margin-bottom: 0;
    }

    .control-option i {
        width: 20px;
        text-align: center;
        font-size: 1.125rem;
        color: var(--accent-color);
    }

    .control-option-content {
        flex: 1;
    }

    .control-option-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .control-option-desc {
        font-size: 0.8125rem;
        color: var(--text-muted);
    }

    /* Flatpickr en modal móvil */
    #flatpickrMobile {
        text-align: center;
        font-size: 1rem;
        padding: 1rem;
    }

    /* ===== SPINER PROFESIONAL ===== */
    .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-left: 1rem;
    }

    .spinner-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
    }

    .spinner-icon i {
        font-size: 0.875rem;
        color: var(--accent-color);
        transition: all 0.3s ease;
    }

    .spinner-icon.rotating i {
        animation: spin 1.5s linear infinite;
    }

    .spinner-icon.success i {
        color: #28a745;
    }

    .spinner-icon.warning i {
        color: #ffc107;
    }

    .spinner-icon.error i {
        color: #dc3545;
    }

    .status-text {
        font-weight: 500;
        white-space: nowrap;
    }

    .status-text.updating {
        color: var(--accent-color);
        font-weight: 600;
    }

    .last-update {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.125rem;
        white-space: nowrap;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .header-controls .control-item:not(.mobile-menu-btn) {
            display: none;
        }
        
        .mobile-menu-btn {
            display: flex;
        }
        
        .header .d-flex.justify-content-between {
            flex-direction: row;
            align-items: center;
        }

        .status-indicator {
            margin-left: 0.5rem;
            gap: 0.5rem;
        }

        .status-text, .last-update {
            font-size: 0.75rem;
        }
    }

    @media (min-width: 769px) {
        .mobile-menu-btn {
            display: none !important;
        }
    }

    /* Ajustes para pantallas medianas */
    @media (max-width: 992px) and (min-width: 769px) {
        .flatpickr-control {
            min-width: 140px;
            max-width: 160px;
        }
        
        .control-btn {
            padding: 0.5rem 0.75rem;
        }
        
        .control-btn .hide-xs {
            font-size: 0.75rem;
        }
    }

    /* Ocultar el flatpickr original del panel de filtros */
    #filtroFecha {
        display: none !important;
    }

    .filtro-group label[for="filtroFecha"] {
        display: none;
    }

    /* Mejoras de alineación y espaciado */
    .header h1 {
        flex-shrink: 0;
    }

    .header-controls {
        flex-shrink: 0;
    }

    /* Estados activos */
    .control-item.active {
        border-color: var(--accent-color);
        background: rgba(15, 52, 96, 0.05);
    }

    .flatpickr-header-input.active {
        color: var(--accent-color);
        font-weight: 500;
    }
    </style>
    
</head>
<body>
    <!-- Header Minimalista -->
    <header class="header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <h1>
                        <i class="fas fa-file-invoice"></i>
                        <span>Separación</span>
                    </h1>
                    
                    <!-- Indicador de estado -->
                    <div class="status-indicator">
                        <div class="spinner-icon" id="statusIcon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <div class="status-text" id="statusText">Listo</div>
                            <div class="last-update" id="lastUpdate">Última actualización: --:--:--</div>
                        </div>
                    </div>
                </div>
                
                <!-- Controles del Header -->
                <div class="header-controls">
                    <!-- Flatpickr -->
                    <div class="control-item flatpickr-control">
                        <input type="text" 
                               class="form-control form-control-sm flatpickr-header-input" 
                               id="filtroFechaHeader" 
                               placeholder="Rango de fechas"
                               autocomplete="off"
                               title="Seleccionar rango de fechas">
                    </div>
                    
                    <!-- Botón Actualizar -->
                    <button type="button" 
                            class="control-item control-btn" 
                            onclick="cargarTablaDocumentos()"
                            title="Actualizar tabla"
                            id="btnActualizar">
                        <i class="fas fa-sync-alt"></i>
                        <span class="hide-xs">Actualizar</span>
                    </button>
                    
                    <!-- Botón Mostrar Finalizados -->
                    <button id="btnToggleFinalizados" 
                            class="control-item control-btn" 
                            onclick="toggleFinalizados()"
                            title="Mostrar/ocultar finalizados">
                        <i class="fas fa-eye"></i>
                        <span class="hide-xs">Finalizados</span>
                    </button>

                    <!-- Botón Menú Móvil -->
                    <button class="mobile-menu-btn" 
                            onclick="abrirModalControles()"
                            title="Opciones">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Modal para Controles Móviles -->
    <div class="modal fade controls-modal" id="controlsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cog me-2"></i>
                        Opciones
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Opción Filtro Fechas -->
                    <div class="control-option" onclick="abrirFlatpickrModal()">
                        <i class="fas fa-calendar-alt"></i>
                        <div class="control-option-content">
                            <div class="control-option-title">Filtrar por Fechas</div>
                            <div class="control-option-desc">Seleccionar rango de fechas</div>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </div>
                    
                    <!-- Opción Actualizar -->
                    <div class="control-option" onclick="ejecutarActualizar()">
                        <i class="fas fa-sync-alt"></i>
                        <div class="control-option-content">
                            <div class="control-option-title">Actualizar Tabla</div>
                            <div class="control-option-desc">Refrescar datos actuales</div>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </div>
                    
                    <!-- Opción Mostrar Finalizados -->
                    <div class="control-option" onclick="ejecutarToggleFinalizados()">
                        <i class="fas fa-eye"></i>
                        <div class="control-option-content">
                            <div class="control-option-title" id="modalToggleText">Mostrar Finalizados</div>
                            <div class="control-option-desc">Ver documentos completados</div>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Flatpickr en Móvil -->
    <div class="modal fade" id="flatpickrModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Rango de Fechas
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" 
                           class="form-control form-control-lg text-center" 
                           id="filtroFechaMobile" 
                           placeholder="Seleccionar rango de fechas"
                           autocomplete="off">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltroFechaMovil()">
                        Limpiar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="aplicarFiltroFechaMovil()">
                        Aplicar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="container-fluid">
        
        <!-- Tarjetas de Resumen Mejoradas -->
        <div class="resumen-grid fade-in" id="resumenTarjetas">
            <div class="resumen-card pendientes">
                <div class="resumen-content">
                    <div class="resumen-text">
                        <h3>Pendientes</h3>
                        <p>Documentos por iniciar</p>
                    </div>
                    <div class="resumen-numbers">
                        <div class="resumen-count" id="contadorPendientes">0</div>
                        <div class="resumen-unidades" id="unidadesPendientes">0 unidades</div>
                    </div>
                </div>
            </div>
            
            <div class="resumen-card proceso">
                <div class="resumen-content">
                    <div class="resumen-text">
                        <h3>En Proceso</h3>
                        <p>Elaboración + Pausadas</p>
                    </div>
                    <div class="resumen-numbers">
                        <div class="resumen-count" id="contadorProceso">0</div>
                        <div class="resumen-unidades" id="unidadesProceso">0 unidades</div>
                    </div>
                </div>
            </div>
            
            <div class="resumen-card directos">
                <div class="resumen-content">
                    <div class="resumen-text">
                        <h3>Directos</h3>
                        <p>Sin distribución</p>
                    </div>
                    <div class="resumen-numbers">
                        <div class="resumen-count" id="contadorDirectos">0</div>
                        <div class="resumen-unidades" id="unidadesDirectos">0 unidades</div>
                    </div>
                </div>
            </div>
            
            <div class="resumen-card total">
                <div class="resumen-content">
                    <div class="resumen-text">
                        <h3>Total Activos</h3>
                        <p>Todos los estados</p>
                    </div>
                    <div class="resumen-numbers">
                        <div class="resumen-count" id="contadorTotal">0</div>
                        <div class="resumen-unidades" id="unidadesTotal">0 unidades</div>
                    </div>
                </div>
            </div>
        </div>


<!-- ===== SISTEMA DE MÉTRICAS DE RENDIMIENTO ===== -->
<!-- Agregar después de las tarjetas de resumen (div.resumen-grid) -->

<!-- Panel de Control de Métricas -->
<div class="card fade-in" style="margin-bottom: var(--spacing-xl);">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="card-title mb-0">
            <i class="fas fa-chart-line"></i>
            Análisis de Rendimiento
        </h5>
        <div class="d-flex align-items-center gap-2">
            <input type="text" 
                   class="form-control form-control-sm" 
                   id="filtroFechasMetricas" 
                   placeholder="Rango de fechas"
                   style="min-width: 180px;"
                   autocomplete="off">
            <button class="btn btn-sm btn-primary" onclick="actualizarMetricas()">
                <i class="fas fa-sync-alt"></i>
                Actualizar
            </button>
        </div>
    </div>
    
    <div class="card-body position-relative">
        <!-- Loader -->
        <div id="metricas-loader" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 10; align-items: center; justify-content: center;">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Calculando métricas...</p>
            </div>
        </div>
        
        <!-- Tarjetas de Métricas Principales -->
        <div class="row g-3 mb-4">
            <!-- Eficiencia -->
            <div class="col-12 col-md-6 col-lg-3">
                <div class="metric-card eficiencia">
                    <div class="metric-content">
                        <div class="metric-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="metric-info">
                            <div class="metric-label">Eficiencia</div>
                            <div class="metric-value" id="metrica-eficiencia">0%</div>
                            <div class="metric-target">Target: 4 seg/unidad</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Capacidad -->
            <div class="col-12 col-md-6 col-lg-3">
                <div class="metric-card capacidad">
                    <div class="metric-content">
                        <div class="metric-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="metric-info">
                            <div class="metric-label">Capacidad</div>
                            <div class="metric-value" id="metrica-capacidad">0%</div>
                            <div class="metric-target">Target: 7920 uds/día</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Efectividad -->
            <div class="col-12 col-md-6 col-lg-3">
                <div class="metric-card efectividad">
                    <div class="metric-content">
                        <div class="metric-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="metric-info">
                            <div class="metric-label">Efectividad</div>
                            <div class="metric-value" id="metrica-efectividad">0%</div>
                            <div class="metric-target">Target: 20 docs/día</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Capacidad Instalada -->
            <div class="col-12 col-md-6 col-lg-3">
                <div class="metric-card capacidad-instalada">
                    <div class="metric-content">
                        <div class="metric-icon">
                            <i class="fas fa-industry"></i>
                        </div>
                        <div class="metric-info">
                            <div class="metric-label">Cap. Instalada</div>
                            <div class="metric-value" id="metrica-capacidad-instalada">0%</div>
                            <div class="metric-target">Capacidad real equipo</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gráfico Radar y Top Semanal -->
        <div class="row g-3">
            <!-- Gráfico Radar -->
            <div class="col-12 col-lg-8">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-user-circle me-2"></i>
                            Análisis Individual
                        </h6>
                        <select class="form-select form-select-sm" 
                                id="selector-responsable-metricas" 
                                style="max-width: 250px;">
                            <option value="">Seleccionar responsable...</option>
                        </select>
                    </div>
                    <canvas id="chartRadar" style="max-height: 400px;"></canvas>
                </div>
            </div>
            
            <!-- Top Semanal -->
            <div class="col-12 col-lg-4">
                <div class="chart-container">
                    <h6 class="mb-3">
                        <i class="fas fa-trophy me-2"></i>
                        Top Semanal
                    </h6>
                    <div id="top-semanal-lista">
                        <!-- Se llenará dinámicamente -->
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-bar" style="font-size: 2rem; opacity: 0.3;"></i>
                            <p class="small mt-2">No hay datos disponibles</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Capacidad Instalada Detallada -->
        <div class="row g-3 mt-3">
            <div class="col-12">
                <div class="chart-container">
                    <h6 class="mb-3">
                        <i class="fas fa-industry me-2"></i>
                        Capacidad Instalada del Equipo
                    </h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="mb-2 text-muted small">Capacidad Real</div>
                            <div class="h3 mb-0" id="capacidad-real-valor">0</div>
                            <div class="small text-muted">unidades/día</div>
                        </div>
                        <div class="col-4">
                            <div class="mb-2 text-muted small">Capacidad Teórica</div>
                            <div class="h3 mb-0" id="capacidad-teorica-valor">0</div>
                            <div class="small text-muted">unidades/día</div>
                        </div>
                        <div class="col-4">
                            <div class="mb-2 text-muted small">Utilización</div>
                            <div class="h3 mb-0" id="capacidad-porcentaje-valor">0%</div>
                            <div class="small text-muted">del total</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== FIN SISTEMA DE MÉTRICAS ===== -->
      

        <!-- Panel de Filtros Mejorado (oculto completamente) -->
<div class="filtros-panel fade-in" style="display: none;">
    <div class="filtros-grid">
        <div class="filtro-group">
            <input type="text" 
                   class="form-control form-control-sm" 
                   id="recInput" 
                   placeholder="Ej: 12345 o 12345,12346,12347"
                   autocomplete="off">
        </div>
        
        <div class="filtro-group">
            <label class="hide-xs">&nbsp;</label>
            <div class="btn-group-sm">
                <button type="button" class="btn btn-primary btn-sm" onclick="buscarPorREC()">
                    <i class="fas fa-search"></i>
                    <span class="hide-xs">Buscar</span>
                </button>
                <button type="button" class="btn btn-info btn-sm" onclick="imprimirSoloClientes()">
                    <i class="fas fa-users"></i>
                    <span class="hide-xs">Clientes</span>
                </button>
                <button type="button" class="btn btn-success btn-sm" onclick="mostrarOpcionesImpresion()">
                    <i class="fas fa-print"></i>
                    <span class="hide-xs">Opciones</span>
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- Tabla de Documentos Mejorada -->
        <div class="card fade-in">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list"></i>
                    Documentos Disponibles
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="documentosTable" class="table table-hover w-100 mb-0">
                        <thead>
                            <tr>
                                <th>Documento</th>
                                <th>Estado</th>
                                <th>Responsable</th>
                                <th>Fecha</th>
                                <th>Duración</th>
                                <th>Cantidad</th>
                                <th class="hide-sm">Prenda</th>
                                <th class="hide-sm">Lote</th>
                                <th class="hide-md">RefProv</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

<!-- Loader Minimalista (oculto por defecto) -->
<div id="loader" class="text-center mt-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2">Cargando datos...</p>
</div>

<!-- Resultados (ocultos por defecto) -->
<div id="resultado" class="mt-3" style="display: none;">
    <!-- Aquí se mostrarán los resultados de búsqueda -->
</div>


    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
    
    <!-- Flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    
    <!-- Scripts de la aplicación -->
    <script src="js/main.js"></script>
    <script src="js/search.js"></script>
    <script src="js/print-templates.js"></script>
    <script src="js/documents-table.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="metrics.js"></script>

    <script>
    // Variables globales para flatpickr
    let flatpickrInstance = null;
    let flatpickrMobileInstance = null;
    let selectedDatesGlobal = [];

    // Variables para el estado de actualización
    let isUpdating = false;
    let lastUpdateTime = null;

    // Inicializar Flatpickr después de que se cargue la página
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Inicializando Flatpickr en header...');
        
        // Inicializar flatpickr del header (PC)
        flatpickrInstance = flatpickr("#filtroFechaHeader", {
            mode: "range",
            locale: "es",
            dateFormat: "d/m/Y",
            allowInput: true,
            onChange: function(selectedDates, dateStr, instance) {
                console.log('Flatpickr PC onChange:', selectedDates);
                selectedDatesGlobal = selectedDates;
                
                // Aplicar filtro automáticamente cuando se selecciona rango completo
                if (selectedDates.length === 2) {
                    aplicarFiltroFecha(selectedDates[0], selectedDates[1]);
                }
            },
            onClose: function(selectedDates, dateStr, instance) {
                console.log('Flatpickr PC onClose:', selectedDates);
                
                // Limpiar si no hay fechas seleccionadas
                if (selectedDates.length === 0) {
                    limpiarFiltroFecha();
                }
            }
        });
        
        console.log('Flatpickr PC inicializado:', flatpickrInstance);
        
        // Hacer disponible globalmente
        window.flatpickrInstance = flatpickrInstance;

        // Inicializar estado de actualización
        updateStatusIndicator('ready', 'Listo');
        updateLastUpdateTime();

        // Añadir animaciones de entrada
        const elements = document.querySelectorAll('.fade-in');
        elements.forEach((el, index) => {
            setTimeout(() => {
                el.style.opacity = '1';
            }, index * 100);
        });
    });

    // ===== FUNCIONES PARA EL INDICADOR DE ESTADO =====
    
    // Función para actualizar el indicador de estado
    function updateStatusIndicator(status, message) {
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        
        // Remover clases anteriores
        statusIcon.classList.remove('rotating', 'success', 'warning', 'error');
        statusText.classList.remove('updating');
        
        switch(status) {
            case 'updating':
                statusIcon.innerHTML = '<i class="fas fa-sync-alt"></i>';
                statusIcon.classList.add('rotating');
                statusText.textContent = message || 'Actualizando...';
                statusText.classList.add('updating');
                isUpdating = true;
                break;
                
            case 'success':
                statusIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                statusIcon.classList.add('success');
                statusText.textContent = message || 'Listo';
                isUpdating = false;
                break;
                
            case 'warning':
                statusIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                statusIcon.classList.add('warning');
                statusText.textContent = message || 'Advertencia';
                isUpdating = false;
                break;
                
            case 'error':
                statusIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                statusIcon.classList.add('error');
                statusText.textContent = message || 'Error';
                isUpdating = false;
                break;
                
            case 'ready':
            default:
                statusIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                statusIcon.classList.add('success');
                statusText.textContent = message || 'Listo';
                isUpdating = false;
                break;
        }
    }
    
    // Función para actualizar la hora de última actualización
    function updateLastUpdateTime() {
        const now = new Date();
        lastUpdateTime = now;
        
        const timeString = now.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        const dateString = now.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
        
        document.getElementById('lastUpdate').textContent = 
            `Última actualización: ${dateString} ${timeString}`;
    }
    
    // Función para iniciar actualización
    function startUpdate() {
        if (isUpdating) return;
        
        updateStatusIndicator('updating', 'Actualizando...');
        
        // Deshabilitar botón de actualizar temporalmente
        const btnActualizar = document.getElementById('btnActualizar');
        if (btnActualizar) {
            btnActualizar.disabled = true;
            btnActualizar.style.opacity = '0.6';
            btnActualizar.style.cursor = 'not-allowed';
        }
    }
    
    // Función para finalizar actualización
    function finishUpdate(success = true, message = null) {
        if (success) {
            updateStatusIndicator('success', message || 'Listo');
            updateLastUpdateTime();
        } else {
            updateStatusIndicator('error', message || 'Error en actualización');
        }
        
        // Rehabilitar botón de actualizar
        const btnActualizar = document.getElementById('btnActualizar');
        if (btnActualizar) {
            setTimeout(() => {
                btnActualizar.disabled = false;
                btnActualizar.style.opacity = '1';
                btnActualizar.style.cursor = 'pointer';
            }, 1000);
        }
    }

    // Función para abrir modal de controles
    function abrirModalControles() {
        const modal = new bootstrap.Modal(document.getElementById('controlsModal'));
        modal.show();
    }

    // Función para abrir flatpickr en modal móvil
    function abrirFlatpickrModal() {
        // Cerrar modal de controles primero
        const controlsModal = bootstrap.Modal.getInstance(document.getElementById('controlsModal'));
        if (controlsModal) {
            controlsModal.hide();
        }
        
        // Abrir modal de flatpickr después de un breve delay
        setTimeout(() => {
            const modal = new bootstrap.Modal(document.getElementById('flatpickrModal'));
            modal.show();
            
            // Inicializar flatpickr móvil
            setTimeout(() => {
                if (flatpickrMobileInstance) {
                    flatpickrMobileInstance.destroy();
                }
                
                flatpickrMobileInstance = flatpickr("#filtroFechaMobile", {
                    mode: "range",
                    locale: "es", 
                    dateFormat: "d/m/Y",
                    allowInput: true,
                    onChange: function(selectedDates, dateStr, instance) {
                        console.log('Flatpickr Mobile onChange:', selectedDates);
                        selectedDatesGlobal = selectedDates;
                    }
                });
                
                // Sincronizar con fechas actuales si existen
                if (selectedDatesGlobal.length > 0) {
                    flatpickrMobileInstance.setDate(selectedDatesGlobal, true);
                }
            }, 300);
        }, 200);
    }

    // Función para aplicar filtro desde móvil
    function aplicarFiltroFechaMovil() {
        console.log('Aplicando filtro desde móvil:', selectedDatesGlobal);
        
        if (selectedDatesGlobal.length === 2) {
            // Aplicar filtro
            aplicarFiltroFecha(selectedDatesGlobal[0], selectedDatesGlobal[1]);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('flatpickrModal'));
            if (modal) {
                modal.hide();
            }
            
            // Mostrar confirmación
            Swal.fire({
                icon: 'success',
                title: 'Filtro aplicado',
                text: `Fechas: ${selectedDatesGlobal[0].toLocaleDateString()} - ${selectedDatesGlobal[1].toLocaleDateString()}`,
                timer: 1500,
                showConfirmButton: false
            });
        } else {
            Swal.fire({
                icon: 'warning',
                title: 'Selecciona un rango',
                text: 'Por favor selecciona un rango de fechas completo',
                timer: 2000,
                showConfirmButton: false
            });
        }
    }

    // Función para limpiar filtro desde móvil
    function limpiarFiltroFechaMovil() {
        if (flatpickrMobileInstance) {
            flatpickrMobileInstance.clear();
        }
        selectedDatesGlobal = [];
        limpiarFiltroFecha();
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('flatpickrModal'));
        if (modal) {
            modal.hide();
        }
        
        Swal.fire({
            icon: 'info',
            title: 'Filtro limpiado',
            timer: 1500,
            showConfirmButton: false
        });
    }

    // Función para aplicar filtro de fecha (común para PC y móvil)
    function aplicarFiltroFecha(fechaInicio, fechaFin) {
        console.log('Aplicando filtro de fecha:', fechaInicio, fechaFin);
        
        if (window.aplicarFiltroFecha) {
            window.aplicarFiltroFecha(fechaInicio, fechaFin);
        } else {
            console.warn('Función aplicarFiltroFecha no disponible');
            // Fallback: recargar tabla o mostrar mensaje
            cargarTablaDocumentos();
        }
    }

    // Función para limpiar filtro de fecha
    function limpiarFiltroFecha() {
        console.log('Limpiando filtro de fecha');
        selectedDatesGlobal = [];
        
        if (flatpickrInstance) {
            flatpickrInstance.clear();
        }
        
        if (window.limpiarFiltros) {
            window.limpiarFiltros();
        } else {
            console.warn('Función limpiarFiltros no disponible');
            cargarTablaDocumentos();
        }
    }

    // Funciones para el modal de controles
    function ejecutarActualizar() {
        cargarTablaDocumentos();
        cerrarModalControles();
        
        Swal.fire({
            icon: 'success',
            title: 'Actualizando...',
            timer: 1000,
            showConfirmButton: false
        });
    }

    function ejecutarToggleFinalizados() {
        toggleFinalizados();
        cerrarModalControles();
        actualizarTextoFinalizados();
    }

    function cerrarModalControles() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('controlsModal'));
        if (modal) {
            modal.hide();
        }
    }

    // Actualizar texto del botón de finalizados
    function actualizarTextoFinalizados() {
        const btn = document.getElementById('btnToggleFinalizados');
        const modalText = document.getElementById('modalToggleText');
        if (btn && modalText) {
            const isShowing = btn.classList.contains('active');
            const text = isShowing ? 'Ocultar Finalizados' : 'Mostrar Finalizados';
            modalText.textContent = text;
        }
    }

    // Sobrescribir toggleFinalizados para actualizar el texto
    const originalToggleFinalizados = window.toggleFinalizados;
    window.toggleFinalizados = function() {
        if (originalToggleFinalizados) {
            originalToggleFinalizados();
        }
        setTimeout(actualizarTextoFinalizados, 100);
    };

    // Sobrescribir cargarTablaDocumentos para incluir indicadores de estado
    const originalCargarTablaDocumentos = window.cargarTablaDocumentos;
    window.cargarTablaDocumentos = function() {
        startUpdate();
        
        if (originalCargarTablaDocumentos) {
            // Si existe la función original, ejecutarla y manejar el resultado
            try {
                const result = originalCargarTablaDocumentos();
                
                // Si devuelve una promesa, manejar el estado
                if (result && typeof result.then === 'function') {
                    result
                        .then(() => finishUpdate(true))
                        .catch(error => {
                            console.error('Error al cargar tabla:', error);
                            finishUpdate(false, 'Error al cargar');
                        });
                } else {
                    // Si no es promesa, asumir éxito después de un tiempo
                    setTimeout(() => finishUpdate(true), 1000);
                }
            } catch (error) {
                console.error('Error al ejecutar cargarTablaDocumentos:', error);
                finishUpdate(false, 'Error al cargar');
            }
        } else {
            // Si no existe la función, simular carga
            console.warn('Función cargarTablaDocumentos no disponible');
            setTimeout(() => finishUpdate(true), 1500);
        }
    };

    // Funciones globales simplificadas
    function buscarDocumentoEnTabla(rec) {
        document.getElementById('recInput').value = rec;
        buscarPorREC();
    }

    function imprimirSoloClientesDesdeTabla(rec) {
        document.getElementById('recInput').value = rec;
        imprimirSoloClientes();
    }

    function mostrarOpcionesDesdeTabla(rec) {
        document.getElementById('recInput').value = rec;
        mostrarOpcionesImpresion();
    }

    // Hacer funciones disponibles globalmente
    window.buscarDocumentoEnTabla = buscarDocumentoEnTabla;
    window.imprimirSoloClientesDesdeTabla = imprimirSoloClientesDesdeTabla;
    window.mostrarOpcionesDesdeTabla = mostrarOpcionesDesdeTabla;
    window.limpiarFiltroFecha = limpiarFiltroFecha;
    window.aplicarFiltroFecha = aplicarFiltroFecha;
    window.abrirFlatpickrModal = abrirFlatpickrModal;
    window.cerrarModalControles = cerrarModalControles;
    window.updateStatusIndicator = updateStatusIndicator;
    window.startUpdate = startUpdate;
    window.finishUpdate = finishUpdate;

    // Inicializar texto de finalizados
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(actualizarTextoFinalizados, 500);
    });

    // Optimización: Prevenir zoom en inputs en iOS
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        const meta = document.querySelector('meta[name="viewport"]');
        meta.content = 'width=device-width, initial-scale=1, maximum-scale=1';
    }
    </script>
</body>
</html>
