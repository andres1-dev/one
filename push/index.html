<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control - Notificaciones Tiempo Real</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark) 0%, #374151 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .status-card i {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .status-card.online { border-left: 4px solid var(--success); }
        .status-card.offline { border-left: 4px solid var(--danger); }
        .status-card.warning { border-left: 4px solid var(--warning); }
        
        .panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .panels {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        
        .panel h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 1rem;
        }
        
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .time-inputs input {
            text-align: center;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); }
        .btn-danger { background: var(--danger); }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .quick-btn {
            padding: 10px;
            font-size: 0.9rem;
        }
        
        .scheduled-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .scheduled-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .scheduled-item:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        
        .scheduled-info {
            flex: 1;
        }
        
        .scheduled-time {
            font-weight: bold;
            color: var(--success);
        }
        
        .cancel-btn {
            background: var(--danger);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }
        
        .logs {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid var(--primary);
        }
        
        .log-success { border-left-color: var(--success); }
        .log-warning { border-left-color: var(--warning); }
        .log-error { border-left-color: var(--danger); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-server"></i> Sistema de Control - Notificaciones Tiempo Real</h1>
            <p>Monitoreo y alertas en tiempo real - Funciona con app cerrada</p>
        </div>

        <!-- Barra de Estado -->
        <div class="status-bar">
            <div class="status-card online">
                <i class="fas fa-satellite-dish"></i>
                <h3>Service Worker</h3>
                <p id="sw-status">Conectando...</p>
            </div>
            <div class="status-card online">
                <i class="fas fa-bell"></i>
                <h3>Notificaciones</h3>
                <p id="notification-status">Permisos pendientes</p>
            </div>
            <div class="status-card online">
                <i class="fas fa-clock"></i>
                <h3>Programadas</h3>
                <p id="scheduled-count">0</p>
            </div>
            <div class="status-card online">
                <i class="fas fa-sync-alt"></i>
                <h3>√öltima Sincronizaci√≥n</h3>
                <p id="last-sync">--:--:--</p>
            </div>
        </div>

        <!-- Paneles Principales -->
        <div class="panels">
            <!-- Panel de Control -->
            <div class="panel">
                <h2><i class="fas fa-sliders-h"></i> Control de Notificaciones</h2>
                
                <div class="form-group">
                    <label for="notification-title"><i class="fas fa-heading"></i> T√≠tulo</label>
                    <input type="text" id="notification-title" value="üö® Alerta del Sistema">
                </div>
                
                <div class="form-group">
                    <label for="notification-message"><i class="fas fa-comment"></i> Mensaje</label>
                    <textarea id="notification-message" rows="3">El sistema ha detectado una actividad importante que requiere tu atenci√≥n inmediata.</textarea>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-hourglass-half"></i> Programar para</label>
                    <div class="time-inputs">
                        <div>
                            <label>Minutos</label>
                            <input type="number" id="schedule-minutes" min="0" value="1">
                        </div>
                        <div>
                            <label>Segundos</label>
                            <input type="number" id="schedule-seconds" min="0" value="0">
                        </div>
                        <div>
                            <label>Acci√≥n</label>
                            <select id="notification-type">
                                <option value="alert">üö® Alerta</option>
                                <option value="info">‚ÑπÔ∏è Informaci√≥n</option>
                                <option value="success">‚úÖ √âxito</option>
                                <option value="warning">‚ö†Ô∏è Advertencia</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button class="btn btn-success" id="request-permission">
                    <i class="fas fa-shield-alt"></i> Habilitar Notificaciones
                </button>
                
                <div class="quick-actions">
                    <button class="btn btn-warning quick-btn" id="test-5s">
                        <i class="fas fa-bolt"></i> Probar 5s
                    </button>
                    <button class="btn quick-btn" id="test-30s">
                        <i class="fas fa-clock"></i> Probar 30s
                    </button>
                    <button class="btn btn-danger quick-btn" id="test-1m">
                        <i class="fas fa-hourglass"></i> Probar 1m
                    </button>
                </div>

                <button class="btn" id="schedule-notification" style="margin-top: 15px;">
                    <i class="fas fa-plus-circle"></i> Programar Notificaci√≥n
                </button>
            </div>

            <!-- Panel de Monitoreo -->
            <div class="panel">
                <h2><i class="fas fa-list"></i> Notificaciones Programadas</h2>
                <div class="scheduled-list" id="scheduled-list">
                    <p style="text-align: center; opacity: 0.7; padding: 20px;">
                        <i class="fas fa-clock"></i><br>
                        No hay notificaciones programadas
                    </p>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3><i class="fas fa-terminal"></i> Logs del Sistema</h3>
                    <div class="logs" id="system-logs">
                        <div class="log-entry">Sistema iniciado - Esperando eventos...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class NotificationSystem {
            constructor() {
                this.swRegistration = null;
                this.scheduledNotifications = [];
                this.localTimers = new Map();
                this.isOnline = false;
                this.heartbeatInterval = null;
                
                this.initialize();
            }

            async initialize() {
                this.addLog('üîß Iniciando sistema de notificaciones...', 'info');
                
                await this.registerServiceWorker();
                await this.requestNotificationPermission();
                await this.loadScheduledNotifications();
                this.setupEventListeners();
                this.startHeartbeat();
                
                this.addLog('‚úÖ Sistema listo - Notificaciones en tiempo real activas', 'success');
            }

            async registerServiceWorker() {
                try {
                    this.swRegistration = await navigator.serviceWorker.register('./sw.js');
                    
                    // Esperar a que est√© activo
                    if (this.swRegistration.installing) {
                        await new Promise(resolve => {
                            this.swRegistration.installing.addEventListener('statechange', () => {
                                if (this.swRegistration.installing.state === 'activated') {
                                    resolve();
                                }
                            });
                        });
                    }
                    
                    this.updateStatus('sw-status', '‚úÖ Activo');
                    this.isOnline = true;
                    
                    // Comunicaci√≥n inicial
                    await this.pingServiceWorker();
                    
                } catch (error) {
                    this.updateStatus('sw-status', '‚ùå Error');
                    this.addLog(`‚ùå Error Service Worker: ${error.message}`, 'error');
                }
            }

            async requestNotificationPermission() {
                try {
                    const permission = await Notification.requestPermission();
                    const status = permission === 'granted' ? '‚úÖ Activas' : '‚ùå Bloqueadas';
                    this.updateStatus('notification-status', status);
                    
                    if (permission === 'granted') {
                        this.addLog('üîî Permisos de notificaci√≥n concedidos', 'success');
                    } else {
                        this.addLog('‚ö†Ô∏è Permisos de notificaci√≥n denegados', 'warning');
                    }
                } catch (error) {
                    this.addLog('‚ùå Error solicitando permisos', 'error');
                }
            }

            async loadScheduledNotifications() {
                try {
                    const notifications = await this.getFromServiceWorker();
                    this.scheduledNotifications = notifications.filter(n => n.scheduledTime > Date.now());
                    this.updateScheduledList();
                } catch (error) {
                    this.addLog('‚ùå Error cargando notificaciones', 'error');
                }
            }

            async getFromServiceWorker() {
                return new Promise((resolve) => {
                    const channel = new MessageChannel();
                    
                    channel.port1.onmessage = (event) => {
                        if (event.data.type === 'SCHEDULED_NOTIFICATIONS') {
                            resolve(event.data.notifications || []);
                        }
                    };
                    
                    if (this.swRegistration?.active) {
                        this.swRegistration.active.postMessage(
                            { type: 'GET_SCHEDULED_NOTIFICATIONS' },
                            [channel.port2]
                        );
                    } else {
                        resolve([]);
                    }
                    
                    // Timeout de seguridad
                    setTimeout(() => resolve([]), 1000);
                });
            }

            async pingServiceWorker() {
                return new Promise((resolve) => {
                    const channel = new MessageChannel();
                    
                    channel.port1.onmessage = (event) => {
                        if (event.data.type === 'PONG') {
                            this.addLog(`ü´Ä Service Worker respondi√≥ en ${Date.now() - event.data.timestamp}ms`, 'success');
                            resolve(true);
                        }
                    };
                    
                    if (this.swRegistration?.active) {
                        this.swRegistration.active.postMessage(
                            { type: 'PING' },
                            [channel.port2]
                        );
                    }
                    
                    setTimeout(() => resolve(false), 1000);
                });
            }

            setupEventListeners() {
                // Botones principales
                document.getElementById('request-permission').addEventListener('click', () => {
                    this.requestNotificationPermission();
                });
                
                document.getElementById('schedule-notification').addEventListener('click', () => {
                    this.scheduleNotification();
                });
                
                // Botones r√°pidos
                document.getElementById('test-5s').addEventListener('click', () => {
                    this.quickSchedule(5);
                });
                
                document.getElementById('test-30s').addEventListener('click', () => {
                    this.quickSchedule(30);
                });
                
                document.getElementById('test-1m').addEventListener('click', () => {
                    this.quickSchedule(60);
                });

                // Escuchar mensajes del Service Worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    this.handleSWMessage(event);
                });
            }

            quickSchedule(seconds) {
                document.getElementById('schedule-minutes').value = Math.floor(seconds / 60);
                document.getElementById('schedule-seconds').value = seconds % 60;
                this.scheduleNotification();
            }

            async scheduleNotification() {
                if (Notification.permission !== 'granted') {
                    this.addLog('‚ö†Ô∏è Primero habilita los permisos de notificaci√≥n', 'warning');
                    return;
                }

                const minutes = parseInt(document.getElementById('schedule-minutes').value) || 0;
                const seconds = parseInt(document.getElementById('schedule-seconds').value) || 0;
                const totalMs = (minutes * 60 + seconds) * 1000;

                if (totalMs <= 0) {
                    this.addLog('‚ùå El tiempo debe ser mayor a 0', 'error');
                    return;
                }

                const title = document.getElementById('notification-title').value || 'Notificaci√≥n del Sistema';
                const body = document.getElementById('notification-message').value || 'Mensaje importante';
                const type = document.getElementById('notification-type').value;
                const id = `ntf-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

                // Timer local para m√°xima precisi√≥n
                const timer = setTimeout(() => {
                    if (Notification.permission === 'granted') {
                        this.showLocalNotification(title, body, type);
                    }
                    this.removeScheduledNotification(id);
                }, totalMs);

                this.localTimers.set(id, timer);

                // Almacenar en Service Worker para persistencia
                const notificationData = {
                    id: id,
                    title: this.getTitleWithEmoji(title, type),
                    body: body,
                    type: type,
                    scheduledTime: Date.now() + totalMs,
                    createdAt: Date.now()
                };

                await this.saveToServiceWorker(notificationData);
                this.scheduledNotifications.push(notificationData);
                this.updateScheduledList();

                const timeStr = this.formatTime(totalMs);
                this.addLog(`‚úÖ Programada para ${timeStr}: ${title}`, 'success');
            }

            getTitleWithEmoji(title, type) {
                const emojis = {
                    alert: 'üö®',
                    info: '‚ÑπÔ∏è',
                    success: '‚úÖ',
                    warning: '‚ö†Ô∏è'
                };
                return `${emojis[type] || 'üì¢'} ${title}`;
            }

            async saveToServiceWorker(notification) {
                if (this.swRegistration?.active) {
                    this.swRegistration.active.postMessage({
                        type: 'ADD_SCHEDULED_NOTIFICATION',
                        data: notification
                    });
                }
            }

            showLocalNotification(title, body, type) {
                const notification = new Notification(title, {
                    body: body,
                    icon: './icon-192.png',
                    badge: './icon-192.png',
                    tag: `local-${Date.now()}`,
                    requireInteraction: true
                });
                
                this.addLog(`üì® Notificaci√≥n enviada: ${title}`, 'success');
            }

            async removeScheduledNotification(id) {
                // Cancelar timer local
                const timer = this.localTimers.get(id);
                if (timer) {
                    clearTimeout(timer);
                    this.localTimers.delete(id);
                }

                // Eliminar del Service Worker
                if (this.swRegistration?.active) {
                    this.swRegistration.active.postMessage({
                        type: 'REMOVE_SCHEDULED_NOTIFICATION',
                        data: { id: id }
                    });
                }

                // Eliminar localmente
                this.scheduledNotifications = this.scheduledNotifications.filter(n => n.id !== id);
                this.updateScheduledList();
                
                this.addLog('üóëÔ∏è Notificaci√≥n cancelada', 'info');
            }

            updateScheduledList() {
                const container = document.getElementById('scheduled-list');
                const countElement = document.getElementById('scheduled-count');
                const now = Date.now();

                // Filtrar expiradas
                this.scheduledNotifications = this.scheduledNotifications.filter(n => n.scheduledTime > now);
                countElement.textContent = this.scheduledNotifications.length;

                if (this.scheduledNotifications.length === 0) {
                    container.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;"><i class="fas fa-clock"></i><br>No hay notificaciones programadas</p>';
                    return;
                }

                // Ordenar por tiempo
                this.scheduledNotifications.sort((a, b) => a.scheduledTime - b.scheduledTime);

                container.innerHTML = this.scheduledNotifications.map(notification => {
                    const timeLeft = notification.scheduledTime - now;
                    const timeStr = this.formatTime(timeLeft);
                    const date = new Date(notification.scheduledTime);
                    
                    return `
                        <div class="scheduled-item">
                            <div class="scheduled-info">
                                <div><strong>${notification.title}</strong></div>
                                <div style="opacity: 0.8; font-size: 0.9em;">${notification.body}</div>
                                <div style="margin-top: 5px;">
                                    <i class="fas fa-clock"></i>
                                    <span class="scheduled-time">${timeStr}</span>
                                    <small>(${date.toLocaleTimeString()})</small>
                                </div>
                            </div>
                            <button class="cancel-btn" onclick="notificationSystem.removeScheduledNotification('${notification.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }

            handleSWMessage(event) {
                const { type, data, timestamp } = event.data;
                
                switch (type) {
                    case 'NOTIFICATIONS_SENT':
                        this.addLog(`üöÄ Service Worker envi√≥ ${data.count} notificaciones`, 'success');
                        this.updateLastSync();
                        break;
                        
                    case 'PONG':
                        this.updateLastSync();
                        break;
                }
            }

            startHeartbeat() {
                this.heartbeatInterval = setInterval(() => {
                    this.updateLastSync();
                    this.updateScheduledList();
                    
                    // Ping ocasional al Service Worker
                    if (Math.random() < 0.1) { // 10% de probabilidad
                        this.pingServiceWorker();
                    }
                }, 1000);
            }

            updateLastSync() {
                document.getElementById('last-sync').textContent = 
                    new Date().toLocaleTimeString();
            }

            updateStatus(elementId, status) {
                document.getElementById(elementId).textContent = status;
            }

            addLog(message, type = 'info') {
                const logsContainer = document.getElementById('system-logs');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                logsContainer.appendChild(logEntry);
                logsContainer.scrollTop = logsContainer.scrollHeight;
                
                // Limitar logs a 50 entradas
                while (logsContainer.children.length > 50) {
                    logsContainer.removeChild(logsContainer.firstChild);
                }
            }

            formatTime(ms) {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                const remainingSeconds = seconds % 60;
                
                if (hours > 0) {
                    return `${hours}h ${remainingMinutes}m ${remainingSeconds}s`;
                } else if (minutes > 0) {
                    return `${minutes}m ${remainingSeconds}s`;
                } else {
                    return `${remainingSeconds}s`;
                }
            }
        }

        // Inicializar el sistema
        const notificationSystem = new NotificationSystem();
        
        // Hacer disponible globalmente
        window.notificationSystem = notificationSystem;
    </script>
</body>
</html>